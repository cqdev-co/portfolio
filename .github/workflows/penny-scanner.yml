name: Market Hours Penny Stock Scanner

on:
  schedule:
    # Run every 10 minutes during US EDT market hours (9:30 AM - 4:00 PM ET)
    # Optimized scan time: ~5-10 minutes (was 40+ minutes)
    - cron: '30,40,50 13 * * 1-5' # 9:30-9:50 AM EDT (13:30-13:50 UTC)
    - cron: '*/10 14-19 * * 1-5' # 10:00 AM - 3:59 PM EDT (every 10 min)
    - cron: '0 20 * * 1-5' # 4:00 PM EDT (20:00 UTC) - Market close
  workflow_dispatch:
    inputs:
      min_score:
        description: 'Minimum signal score threshold'
        required: false
        default: '0.70'
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  scan-penny-stocks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: penny-stock-scanner/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('penny-stock-scanner/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        working-directory: penny-stock-scanner
        run: poetry install --only=main

      - name: Run Penny Stock Scanner
        working-directory: penny-stock-scanner
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY }}
          # Discord alerts for S/A-Tier signals
          DISCORD_PENNY_WEBHOOK_URL: ${{ secrets.DISCORD_PENNY_WEBHOOK_URL }}
        run: poetry run penny-scanner scan-all --min-score ${{ github.event.inputs.min_score || '0.60' }}
