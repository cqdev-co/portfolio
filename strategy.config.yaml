# =============================================================================
# DEEP ITM CALL DEBIT SPREAD STRATEGY CONFIGURATION
# =============================================================================
#
# This file defines the rules for the Deep ITM Call Debit Spread strategy.
# All services (ai-analyst, screen-ticker, spread_quant_analysis) should
# read from this config to ensure consistent entry/exit criteria.
#
# RULE: If ANY entry criterion is not met, DO NOT TRADE.
#
# Last Updated: 2026-01-23
# =============================================================================

strategy:
  name: 'Deep ITM Call Debit Spread'
  version: '1.0.0'
  description: |
    Bullish defined-risk options strategy using deep in-the-money call 
    debit spreads on quality stocks with strong technicals and fundamentals.

# =============================================================================
# ENTRY CRITERIA - ALL must be satisfied
# =============================================================================
entry:
  # --- Trend ---
  trend:
    above_ma200: true # Price must be above 200-day MA
    above_ma50: true # Price must be above 50-day MA (preferred)
    ma50_above_ma200: false # Golden cross (optional, adds conviction)

  # --- Momentum ---
  momentum:
    rsi_min: 30 # Not oversold (bouncing knife)
    rsi_max: 55 # Not overbought (chasing)
    rsi_ideal_min: 35 # Sweet spot lower bound
    rsi_ideal_max: 50 # Sweet spot upper bound

  # --- Cushion (distance from breakeven to current price) ---
  cushion:
    minimum_pct: 7.0 # Hard floor - never go below
    preferred_pct: 10.0 # Ideal cushion
    excellent_pct: 15.0 # Strong conviction level

  # --- Volatility ---
  volatility:
    iv_max_pct: 50 # Max implied volatility
    iv_preferred_max_pct: 40 # Preferred IV ceiling
    iv_rank_max: 60 # IV percentile (avoid elevated IV)
    avoid_if_iv_above: 60 # Hard stop - too expensive

  # --- Earnings ---
  earnings:
    min_days_until: 14 # Minimum days until earnings
    preferred_days_until: 21 # Comfortable buffer
    never_hold_through: true # Exit before earnings event

  # --- Sentiment ---
  sentiment:
    analyst_bullish_min_pct: 70 # Minimum bullish analyst %
    analyst_bullish_preferred: 80 # Preferred bullish %
    analyst_count_min: 5 # Minimum analysts covering

  # --- Fundamentals (optional filters) ---
  fundamentals:
    require_positive_eps: true
    max_pe_ratio: 100 # Avoid extreme valuations
    min_market_cap_b: 5 # $5B minimum (liquidity)

  # --- Spread-Specific ---
  spread:
    min_return_on_risk_pct: 15 # Minimum R/R ratio
    preferred_ror_pct: 20 # Preferred return on risk
    min_open_interest: 50 # Both legs must have OI
    max_bid_ask_spread_pct: 5 # Avoid illiquid strikes
    min_pop_pct: 60 # Minimum probability of profit
    min_debit_ratio_pct: 55 # Minimum debit as % of width (avoid "too good to be true")
    max_debit_ratio_pct: 80 # Maximum debit as % of width (maintain profit potential)

# =============================================================================
# EXIT RULES
# =============================================================================
# LESSON 001 (AVGO Jan 2026): Never hold spreads to expiration for max profit.
# A 28-day winner became a -$200 loss by holding through final week.
# =============================================================================
exit:
  # --- Profit Taking (% of MAX PROFIT, not debit paid) ---
  # Max profit = spread width - debit paid
  # Example: $5 spread, $3.50 debit → max profit = $1.50
  profit:
    # Tiered exit targets (choose based on conviction & time remaining)
    min_acceptable_pct: 50 # Floor - always accept 50% of max profit
    target_pct: 75 # Standard target - CLOSE HERE (Lesson 001)
    greed_limit_pct: 80 # HARD CEILING - never hold past 80%

    # Quick profit rules
    early_exit_threshold_pct: 50 # If 50%+ in first 7 days, consider exit
    early_exit_days: 7 # Window for early exit consideration

    # CRITICAL: Max profit chasing is FORBIDDEN
    # See: docs/lessons/001-holding-till-max-profit.md
    never_chase_max_profit: true # Psychological reminder

    scale_out: false # Full exit (don't partial)

  # --- Stop Loss ---
  stop_loss:
    max_loss_pct: 40 # Hard stop at -40% of debit
    time_stop_days: null # Optional: exit after N days regardless

  # --- Time-Based (CRITICAL - Lesson 001) ---
  time:
    max_hold_days: 25 # Start looking for exits

    # GAMMA RISK ZONE - mandatory exit triggers
    # Gamma explodes in final week, small moves = big P&L swings
    gamma_risk_zone_dte: 7 # Enter danger zone at 7 DTE
    forced_exit_dte: 5 # MANDATORY EXIT by 5 DTE regardless of P&L

    # The rule: Close at 75% profit OR 5 DTE, WHICHEVER COMES FIRST
    exit_rule: 'CLOSE_AT_75_OR_5DTE_FIRST'

  # --- Event-Based ---
  events:
    exit_before_earnings: true
    exit_on_major_news: true # Fed, CPI, etc.

  # --- Pin Risk Warning ---
  # If stock approaches short strike with >3 DTE, EXIT IMMEDIATELY
  pin_risk:
    enabled: true
    cushion_warning_pct: 3 # Warn if cushion drops below 3%
    cushion_exit_pct: 2 # Force exit if cushion drops below 2%
    dte_threshold: 3 # Only applies within 3 DTE

# =============================================================================
# POSITION SIZING
# =============================================================================
position_sizing:
  # --- Per-Position Limits ---
  max_single_position_pct: 20 # Max % of account per position
  preferred_position_pct: 15 # Typical position size
  min_position_pct: 5 # Don't go smaller than this

  # --- Portfolio Limits ---
  max_total_deployed_pct: 65 # Max capital in positions
  preferred_deployed_pct: 50 # Normal deployment
  max_concurrent_positions: 6 # Diversification limit

  # --- Scaling Rules ---
  scaling:
    # As account grows, adjust position sizing
    - account_min: 0
      account_max: 5000
      max_position_pct: 20
      max_positions: 4
    - account_min: 5000
      account_max: 10000
      max_position_pct: 15
      max_positions: 6
    - account_min: 10000
      account_max: 25000
      max_position_pct: 12
      max_positions: 8
    - account_min: 25000
      account_max: 100000
      max_position_pct: 8
      max_positions: 12

# =============================================================================
# SPREAD PARAMETERS
# =============================================================================
spread_params:
  # --- Days to Expiration ---
  dte:
    target: 30 # Target DTE for new positions
    min: 21 # Don't go shorter than this
    max: 45 # Don't go longer than this

  # --- Spread Width ---
  width:
    # Width based on account size
    - account_max: 2500
      width: 5
      typical_debit: 350
    - account_max: 5000
      width: 5
      typical_debit: 350
    - account_max: 10000
      width: 7.5
      typical_debit: 525
    - account_max: 50000
      width: 10
      typical_debit: 700

  # --- Strike Selection ---
  strikes:
    long_strike_delta_min: 0.70 # Deep ITM (70+ delta)
    long_strike_delta_max: 0.85 # Not too deep (expensive)
    short_strike_delta_min: 0.50 # ATM or slightly ITM
    short_strike_delta_max: 0.60 # Near the money

# =============================================================================
# RISK MANAGEMENT
# =============================================================================
risk_management:
  # --- Circuit Breakers ---
  circuit_breakers:
    consecutive_losses_pause: 3 # Pause after 3 losses
    pause_duration_hours: 48 # How long to pause
    monthly_drawdown_reduce_pct: 20 # Reduce size if -20% monthly
    monthly_drawdown_stop_pct: 30 # Stop trading if -30% monthly

  # --- Correlation Limits ---
  correlation:
    max_same_sector: 3 # Max positions in same sector
    max_correlated_positions: 4 # Max highly correlated trades

  # --- Blacklist ---
  blacklist:
    # Tickers to never trade (add your own)
    tickers: [CRWD]
    # Sectors to avoid (if any)
    sectors: []

# =============================================================================
# TICKER UNIVERSE
# =============================================================================
universe:
  # --- Tier 1: Primary Focus (trade frequently) ---
  tier1:
    - AAPL
    - MSFT
    - GOOGL
    - AMZN
    - META

  # --- Tier 2: Secondary (trade selectively) ---
  tier2:
    - NVDA
    - AMD
    - AVGO
    - CRM
    - NFLX
    - ORCL
    - ADBE

  # --- Tier 3: Opportunistic (only on strong signals) ---
  tier3:
    - TSLA
    - JPM
    - V
    - MA
    - UNH
    - JNJ
    - PG

  # --- Scanner Universe ---
  scanner:
    min_price: 20 # Avoid penny stocks
    max_price: 1000 # Avoid super expensive
    min_volume: 500000 # Daily volume minimum
    min_market_cap_b: 10 # $10B minimum for scanner

# =============================================================================
# MARKET REGIME ADJUSTMENTS
# =============================================================================
# Adjust entry criteria based on market conditions (SPY-based)
market_regime:
  # --- Bull Market (SPY above MA200, golden cross active) ---
  bull:
    enabled: true
    description: 'Standard entry criteria, full position sizes'
    adjustments:
      min_score: 65 # Lower threshold - more opportunities
      rsi_max: 60 # Allow slightly extended stocks
      position_size_multiplier: 1.0 # Full positions
      max_concurrent_positions: 6
      require_ma50_above: false # MA200 sufficient

  # --- Neutral Market (SPY near MA200, mixed signals) ---
  neutral:
    enabled: true
    description: 'Selective entries, reduced sizes'
    adjustments:
      min_score: 70 # Higher bar for entry
      rsi_max: 55 # Stricter RSI limit
      position_size_multiplier: 0.75 # 75% position size
      max_concurrent_positions: 4
      require_ma50_above: true # Both MAs required

  # --- Bear Market (SPY below MA200, death cross) ---
  bear:
    enabled: true
    description: 'Defensive mode, only high-conviction trades'
    adjustments:
      min_score: 80 # Very high bar
      rsi_max: 50 # Only buy on weakness
      rsi_min: 25 # Avoid severe oversold (falling knife)
      position_size_multiplier: 0.50 # Half positions
      max_concurrent_positions: 2
      require_ma50_above: true
      require_golden_cross: true # Stock must have healthy structure
      cushion_minimum_pct: 10.0 # Extra cushion required

  # --- No-Trade Conditions (circuit breaker) ---
  no_trade:
    # When these conditions are met, avoid new entries entirely
    spy_below_ma200_pct: -10 # SPY 10%+ below MA200
    vix_above: 35 # VIX spike (fear)
    consecutive_down_days: 5 # Extended selloff

# =============================================================================
# ALERTS & NOTIFICATIONS
# =============================================================================
alerts:
  # When to send alerts
  triggers:
    scanner_finds_entry: true # New opportunity
    position_hits_target: true # Profit target reached
    position_hits_stop: true # Stop loss triggered
    earnings_approaching: true # 7 days to earnings
    rule_violation_attempt: true # Tried to break a rule

# =============================================================================
# VALIDATION
# =============================================================================
validation:
  # Minimum score required from AI analyst
  min_ai_score: 65

  # Minimum confidence for automated entry
  min_confidence: 70

  # Require human confirmation above this $ amount
  human_confirm_above: 500

# =============================================================================
# LESSONS LEARNED
# =============================================================================
# This config evolves based on real trading lessons. Each lesson that changes
# a rule is documented here for context and accountability.
# Full lesson details: docs/lessons/
# =============================================================================
lessons:
  - id: '001'
    title: "Don't Hold Spreads to Expiration for Max Profit"
    date: '2026-01-23'
    ticker: AVGO
    cost: -200
    rules_changed:
      - 'exit.profit.target_pct: 35 → 75 (of max profit)'
      - 'exit.profit.greed_limit_pct: NEW at 80%'
      - 'exit.time.forced_exit_dte: NEW at 5 DTE'
      - 'exit.pin_risk: NEW section added'
    summary: |
      Held winning spread for 28 days, lost $200 by holding to DTE.
      Rule: Close at 75% profit OR 5 DTE, whichever comes first.
