# =============================================================================
# DEEP ITM CALL DEBIT SPREAD STRATEGY CONFIGURATION
# =============================================================================
#
# This file defines the rules for the Deep ITM Call Debit Spread strategy.
# All services (ai-analyst, screen-ticker, spread_quant_analysis) should
# read from this config to ensure consistent entry/exit criteria.
#
# RULE: If ANY entry criterion is not met, DO NOT TRADE.
#
# Last Updated: 2026-01-23
# =============================================================================

strategy:
  name: 'Deep ITM Call Debit Spread'
  version: '1.0.0'
  description: |
    Bullish defined-risk options strategy using deep in-the-money call 
    debit spreads on quality stocks with strong technicals and fundamentals.

# =============================================================================
# ENTRY CRITERIA - ALL must be satisfied
# =============================================================================
entry:
  # --- Trend ---
  trend:
    above_ma200: true # Price must be above 200-day MA
    above_ma50: true # Price must be above 50-day MA (preferred)
    ma50_above_ma200: false # Golden cross (optional, adds conviction)

  # --- Momentum ---
  momentum:
    rsi_min: 30 # Not oversold (bouncing knife)
    rsi_max: 55 # Not overbought (chasing)
    rsi_ideal_min: 35 # Sweet spot lower bound
    rsi_ideal_max: 50 # Sweet spot upper bound

  # --- Cushion (distance from breakeven to current price) ---
  # v2.9.0: Lowered minimum from 7% to 5%. The 7% floor was too aggressive
  # for deep ITM spreads — it conflicted with debit ratio limits, causing
  # zero viable trades. 5% still provides meaningful downside protection
  # (~$5 buffer on a $100 stock) while allowing the scanner to surface setups.
  cushion:
    minimum_pct: 5.0 # Hard floor - never go below (was 7.0)
    preferred_pct: 8.0 # Ideal cushion (was 10.0)
    excellent_pct: 12.0 # Strong conviction level (was 15.0)

  # --- Volatility ---
  volatility:
    iv_max_pct: 50 # Max implied volatility
    iv_preferred_max_pct: 40 # Preferred IV ceiling
    iv_rank_max: 60 # IV percentile (avoid elevated IV)
    avoid_if_iv_above: 60 # Hard stop - too expensive

  # --- Earnings ---
  earnings:
    min_days_until: 14 # Minimum days until earnings
    preferred_days_until: 21 # Comfortable buffer
    never_hold_through: true # Exit before earnings event

  # --- Sentiment ---
  sentiment:
    analyst_bullish_min_pct: 70 # Minimum bullish analyst %
    analyst_bullish_preferred: 80 # Preferred bullish %
    analyst_count_min: 5 # Minimum analysts covering

  # --- Fundamentals (optional filters) ---
  fundamentals:
    require_positive_eps: true
    max_pe_ratio: 100 # Avoid extreme valuations
    min_market_cap_b: 5 # $5B minimum (liquidity)

  # --- Spread-Specific ---
  spread:
    min_return_on_risk_pct: 15 # Minimum R/R ratio
    preferred_ror_pct: 20 # Preferred return on risk
    min_open_interest: 50 # Both legs must have OI
    max_bid_ask_spread_pct: 5 # Avoid illiquid strikes
    min_pop_pct: 60 # Minimum probability of profit
    min_debit_ratio_pct: 55 # Minimum debit as % of width (avoid "too good to be true")
    max_debit_ratio_pct: 85 # Maximum debit as % of width (was 80; raised for deep ITM realism)

# =============================================================================
# EXIT RULES
# =============================================================================
# LESSON 001 (AVGO Jan 2026): Never hold spreads to expiration for max profit.
# A 28-day winner became a -$200 loss by holding through final week.
# =============================================================================
exit:
  # --- Profit Taking (% of MAX PROFIT, not debit paid) ---
  # Max profit = spread width - debit paid
  # Example: $5 spread, $3.50 debit → max profit = $1.50
  profit:
    # Tiered exit targets (choose based on conviction & time remaining)
    min_acceptable_pct: 50 # Floor - always accept 50% of max profit
    target_pct: 75 # Standard target - CLOSE HERE (Lesson 001)
    greed_limit_pct: 80 # HARD CEILING - never hold past 80%

    # Quick profit rules
    early_exit_threshold_pct: 50 # If 50%+ in first 7 days, consider exit
    early_exit_days: 7 # Window for early exit consideration

    # CRITICAL: Max profit chasing is FORBIDDEN
    # See: docs/lessons/001-holding-till-max-profit.md
    never_chase_max_profit: true # Psychological reminder

    scale_out: false # Full exit (don't partial)

  # --- Stop Loss ---
  stop_loss:
    max_loss_pct: 40 # Hard stop at -40% of debit
    time_stop_days: null # Optional: exit after N days regardless

  # --- Time-Based (CRITICAL - Lesson 001) ---
  time:
    max_hold_days: 25 # Start looking for exits

    # GAMMA RISK ZONE - mandatory exit triggers
    # Gamma explodes in final week, small moves = big P&L swings
    gamma_risk_zone_dte: 7 # Enter danger zone at 7 DTE
    forced_exit_dte: 5 # MANDATORY EXIT by 5 DTE regardless of P&L

    # The rule: Close at 75% profit OR 5 DTE, WHICHEVER COMES FIRST
    exit_rule: 'CLOSE_AT_75_OR_5DTE_FIRST'

  # --- Event-Based ---
  events:
    exit_before_earnings: true
    exit_on_major_news: true # Fed, CPI, etc.

  # --- Pin Risk Warning ---
  # If stock approaches short strike with >3 DTE, EXIT IMMEDIATELY
  pin_risk:
    enabled: true
    cushion_warning_pct: 3 # Warn if cushion drops below 3%
    cushion_exit_pct: 2 # Force exit if cushion drops below 2%
    dte_threshold: 3 # Only applies within 3 DTE

# =============================================================================
# POSITION SIZING
# =============================================================================
position_sizing:
  # --- Per-Position Limits ---
  max_single_position_pct: 20 # Max % of account per position
  preferred_position_pct: 15 # Typical position size
  min_position_pct: 5 # Don't go smaller than this

  # --- Portfolio Limits ---
  max_total_deployed_pct: 65 # Max capital in positions
  preferred_deployed_pct: 50 # Normal deployment
  max_concurrent_positions: 6 # Diversification limit

  # --- Scaling Rules ---
  scaling:
    # As account grows, adjust position sizing
    - account_min: 0
      account_max: 5000
      max_position_pct: 20
      max_positions: 4
    - account_min: 5000
      account_max: 10000
      max_position_pct: 15
      max_positions: 6
    - account_min: 10000
      account_max: 25000
      max_position_pct: 12
      max_positions: 8
    - account_min: 25000
      account_max: 100000
      max_position_pct: 8
      max_positions: 12

# =============================================================================
# SPREAD PARAMETERS
# =============================================================================
spread_params:
  # --- Days to Expiration ---
  dte:
    target: 30 # Target DTE for new positions
    min: 21 # Don't go shorter than this
    max: 45 # Don't go longer than this

  # --- Spread Width ---
  width:
    # Width based on account size
    - account_max: 2500
      width: 5
      typical_debit: 350
    - account_max: 5000
      width: 5
      typical_debit: 350
    - account_max: 10000
      width: 7.5
      typical_debit: 525
    - account_max: 50000
      width: 10
      typical_debit: 700

  # --- Strike Selection ---
  strikes:
    long_strike_delta_min: 0.70 # Deep ITM (70+ delta)
    long_strike_delta_max: 0.85 # Not too deep (expensive)
    short_strike_delta_min: 0.50 # ATM or slightly ITM
    short_strike_delta_max: 0.60 # Near the money

# =============================================================================
# RISK MANAGEMENT
# =============================================================================
risk_management:
  # --- Circuit Breakers ---
  circuit_breakers:
    consecutive_losses_pause: 3 # Pause after 3 losses
    pause_duration_hours: 48 # How long to pause
    monthly_drawdown_reduce_pct: 20 # Reduce size if -20% monthly
    monthly_drawdown_stop_pct: 30 # Stop trading if -30% monthly

  # --- Correlation Limits ---
  correlation:
    max_same_sector: 3 # Max positions in same sector
    max_correlated_positions: 4 # Max highly correlated trades

  # --- Blacklist ---
  blacklist:
    # Tickers to never trade (add your own)
    tickers: [CRWD]
    # Sectors to avoid (if any)
    sectors: []

# =============================================================================
# TICKER UNIVERSE
# =============================================================================
universe:
  # --- Tier 1: Primary Focus (trade frequently) ---
  tier1:
    - AAPL
    - MSFT
    - GOOGL
    - AMZN
    - META

  # --- Tier 2: Secondary (trade selectively) ---
  tier2:
    - NVDA
    - AMD
    - AVGO
    - CRM
    - NFLX
    - ORCL
    - ADBE

  # --- Tier 3: Opportunistic (only on strong signals) ---
  tier3:
    - TSLA
    - JPM
    - V
    - MA
    - UNH
    - JNJ
    - PG

  # --- Scanner Universe ---
  scanner:
    min_price: 20 # Avoid penny stocks
    max_price: 1000 # Avoid super expensive
    min_volume: 500000 # Daily volume minimum
    min_market_cap_b: 10 # $10B minimum for scanner

# =============================================================================
# MARKET REGIME ADJUSTMENTS
# =============================================================================
# Adjust entry criteria based on market conditions (SPY-based)
market_regime:
  # --- Bull Market (SPY above MA200, golden cross active) ---
  bull:
    enabled: true
    description: 'Standard entry criteria, full position sizes'
    adjustments:
      min_score: 65 # Lower threshold - more opportunities
      rsi_max: 60 # Allow slightly extended stocks
      position_size_multiplier: 1.0 # Full positions
      max_concurrent_positions: 6
      require_ma50_above: false # MA200 sufficient

  # --- Neutral Market (SPY near MA200, mixed signals) ---
  neutral:
    enabled: true
    description: 'Selective entries, reduced sizes'
    adjustments:
      min_score: 70 # Higher bar for entry
      rsi_max: 55 # Stricter RSI limit
      position_size_multiplier: 0.75 # 75% position size
      max_concurrent_positions: 4
      require_ma50_above: true # Both MAs required

  # --- Bear Market (SPY below MA200, death cross) ---
  bear:
    enabled: true
    description: 'Defensive mode, only high-conviction trades'
    adjustments:
      min_score: 80 # Very high bar
      rsi_max: 50 # Only buy on weakness
      rsi_min: 25 # Avoid severe oversold (falling knife)
      position_size_multiplier: 0.50 # Half positions
      max_concurrent_positions: 2
      require_ma50_above: true
      require_golden_cross: true # Stock must have healthy structure
      cushion_minimum_pct: 10.0 # Extra cushion required

  # --- No-Trade Conditions (circuit breaker) ---
  no_trade:
    # When these conditions are met, avoid new entries entirely
    spy_below_ma200_pct: -10 # SPY 10%+ below MA200
    vix_above: 35 # VIX spike (fear)
    consecutive_down_days: 5 # Extended selloff

# =============================================================================
# ALERTS & NOTIFICATIONS
# =============================================================================
alerts:
  # When to send alerts
  triggers:
    scanner_finds_entry: true # New opportunity
    position_hits_target: true # Profit target reached
    position_hits_stop: true # Stop loss triggered
    earnings_approaching: true # 7 days to earnings
    rule_violation_attempt: true # Tried to break a rule

# =============================================================================
# VALIDATION
# =============================================================================
validation:
  # Minimum score required from AI analyst
  min_ai_score: 65

  # Minimum confidence for automated entry
  min_confidence: 70

  # Require human confirmation above this $ amount
  human_confirm_above: 500

# =============================================================================
# LESSONS LEARNED
# =============================================================================
# This config evolves based on real trading lessons. Each lesson that changes
# a rule is documented here for context and accountability.
# Full lesson details: docs/lessons/
# =============================================================================
lessons:
  - id: '001'
    title: "Don't Hold Spreads to Expiration for Max Profit"
    date: '2026-01-23'
    ticker: AVGO
    cost: -200
    rules_changed:
      - 'exit.profit.target_pct: 35 → 75 (of max profit)'
      - 'exit.profit.greed_limit_pct: NEW at 80%'
      - 'exit.time.forced_exit_dte: NEW at 5 DTE'
      - 'exit.pin_risk: NEW section added'
    summary: |
      Held winning spread for 28 days, lost $200 by holding to DTE.
      Rule: Close at 75% profit OR 5 DTE, whichever comes first.

  - id: '002'
    title: 'Viable Spread Criteria Too Restrictive — Zero Trades'
    date: '2026-02-09'
    ticker: ALL
    cost: 0
    rules_changed:
      - 'entry.cushion.minimum_pct: 7.0 → 5.0'
      - 'entry.cushion.preferred_pct: 10.0 → 8.0'
      - 'entry.cushion.excellent_pct: 15.0 → 12.0'
      - 'entry.spread.max_debit_ratio_pct: 80 → 85'
      - 'scan-spreads: Try mid-market debit when market debit exceeds max ratio'
    summary: |
      Cushion ≥7% and debit ratio ≤80% were structurally contradictory for 
      deep ITM spreads. Deeper strikes give better cushion but higher debit 
      ratios (bid-ask inflates market debit). Scanner also hard-rejected 
      spreads above max debit without trying mid-market pricing. Three fixes:
      (1) lower cushion floor to 5%, (2) raise debit cap to 85%, 
      (3) fall back to mid-market debit before rejecting.

# =============================================================================
# PUT CREDIT SPREAD (PCS) STRATEGY CONFIGURATION
# =============================================================================
#
# Bullish/neutral defined-risk options strategy selling OTM put credit spreads
# on quality stocks with strong support levels and elevated IV.
#
# Key differences from CDS:
# - SELL premium (receive credit) instead of buying
# - Profits from theta decay and stock staying above short strike
# - IV preference is INVERTED: higher IV = better (more premium)
# - RSI ideal zone: 40-55 (neutral/slightly bullish)
# - Short strike placed BELOW support for protection
#
# =============================================================================

pcs_strategy:
  name: 'Put Credit Spread'
  version: '1.0.0'
  description: |
    Bullish/neutral defined-risk options strategy selling OTM put
    credit spreads on quality stocks with strong support levels.

# =============================================================================
# PCS ENTRY CRITERIA
# =============================================================================
pcs_entry:
  # --- Trend ---
  trend:
    above_ma50: true # Primary requirement (less strict than CDS)
    above_ma200: false # Preferred but not required

  # --- Momentum ---
  momentum:
    rsi_min: 35 # Not deeply oversold (falling knife risk)
    rsi_max: 65 # Not extremely overbought
    rsi_ideal_min: 40 # Sweet spot lower (shifted up from CDS)
    rsi_ideal_max: 55 # Sweet spot upper

  # --- Implied Volatility (INVERTED from CDS) ---
  iv:
    iv_rank_min: 20 # Minimum to make credit worthwhile
    iv_rank_preferred: 40 # Good premium level
    iv_rank_ideal: 50 # Sweet spot for selling
    iv_rank_caution: 80 # Extreme IV — may signal danger

  # --- Cushion (distance of short strike below current price) ---
  cushion:
    minimum_pct: 5.0 # Hard floor for distance OTM
    preferred_pct: 8.0 # Ideal distance
    excellent_pct: 12.0 # Very comfortable

  # --- Earnings ---
  earnings:
    min_days_until: 14 # Buffer before earnings
    preferred_days_until: 21
    never_hold_through: true

  # --- Fundamentals ---
  fundamentals:
    require_positive_eps: true
    max_pe_ratio: 100
    min_market_cap_b: 5

  # --- Spread-Specific ---
  spread:
    min_credit_ratio_pct: 20 # Minimum credit as % of width
    max_credit_ratio_pct: 45 # Max (too high = too risky)
    ideal_credit_ratio_pct: 30 # Sweet spot
    min_return_on_risk_pct: 20
    min_open_interest: 50
    max_bid_ask_spread_pct: 5
    min_pop_pct: 65 # Higher than CDS since OTM

# =============================================================================
# PCS EXIT RULES
# =============================================================================
pcs_exit:
  # --- Profit Taking (% of CREDIT RECEIVED) ---
  profit:
    target_pct: 50 # Standard: close at 50% of credit
    greed_limit_pct: 75 # Set trailing stop at 75%
    early_exit_threshold_pct: 40 # Quick profit in first week
    early_exit_days: 5
    never_chase_max_profit: true

  # --- Stop Loss ---
  stop_loss:
    max_loss_multiplier: 2.0 # Close if loss = 2x credit received
    max_loss_pct_of_width: 75 # Or 75% of width, whichever first
    support_breach_exit: true # Exit if support breaks

  # --- Time-Based ---
  time:
    max_hold_days: 30
    gamma_risk_zone_dte: 7
    forced_exit_dte: 7 # Less urgent than CDS (theta helps PCS)
    exit_rule: 'CLOSE_AT_50_OR_7DTE_FIRST'

  # --- Event-Based ---
  events:
    exit_before_earnings: true
    exit_on_major_news: true

  # --- Pin Risk ---
  pin_risk:
    enabled: true
    cushion_warning_pct: 3
    cushion_exit_pct: 1.5
    dte_threshold: 5

  # --- Roll Rules ---
  roll:
    enabled: true
    roll_if_tested: true # Short strike tested (price approaches)
    roll_dte_trigger: 10 # Roll when DTE < 10 if still open
    roll_target_dte: 30 # Roll to 30 DTE
    same_or_lower_strike: true # Never roll UP

# =============================================================================
# PCS SPREAD PARAMETERS
# =============================================================================
pcs_spread_params:
  # --- Days to Expiration ---
  dte:
    target: 35 # Target DTE (slightly longer than CDS)
    min: 21
    max: 45

  # --- Spread Width ---
  width:
    - account_max: 5000
      width: 5
      typical_credit: 100
    - account_max: 10000
      width: 5
      typical_credit: 125
    - account_max: 25000
      width: 10
      typical_credit: 250
    - account_max: 100000
      width: 10
      typical_credit: 300

  # --- Strike Selection ---
  strikes:
    short_put_delta_min: 0.20 # Floor (far OTM)
    short_put_delta_max: 0.35 # Ceiling (getting closer to ATM)
    short_put_delta_ideal: 0.25 # Sweet spot
    long_put_offset: 5 # Width in dollars below short

# =============================================================================
# PCS POSITION SIZING
# =============================================================================
pcs_position_sizing:
  max_single_position_pct: 15 # More conservative than CDS
  preferred_position_pct: 10
  min_position_pct: 5
  max_total_deployed_pct: 50 # Lower cap than CDS
  preferred_deployed_pct: 35
  max_concurrent_positions: 5

# =============================================================================
# PCS MARKET REGIME ADJUSTMENTS
# =============================================================================
pcs_market_regime:
  bull:
    adjustments:
      min_score: 60
      rsi_max: 65
      position_size_multiplier: 1.0
      max_concurrent_positions: 5
  neutral:
    adjustments:
      min_score: 70
      rsi_max: 60
      position_size_multiplier: 0.65
      max_concurrent_positions: 3
  bear:
    adjustments:
      min_score: 999 # Effectively no new positions
      rsi_max: 50
      position_size_multiplier: 0.0
      max_concurrent_positions: 0
      note: 'Do NOT sell puts in a bear market'
